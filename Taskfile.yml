# GLG-Mono Font Build System
# https://taskfile.dev
#
# This build system is derived from PlemolKR by soomtong
# Copyright (c) 2025 soomtong
# Copyright (c) 2025 Junghan Kim (junghan0611)

version: '3'

vars:
  GREETING: "GLG-Mono Font Build System"
  VERSION:
    sh: grep "VERSION" build.ini | cut -d "=" -f 2 | tr -d " "

tasks:
  default:
    desc: ë¹Œë“œ ì‹œìŠ¤í…œ ì •ë³´ í‘œì‹œ
    silent: true
    cmds:
      - echo "{{.GREETING}}"
      - echo "ë²„ì „{{"{{"}} .VERSION {{"}}"}}"
      - echo ""
      - task --list-all

  # ============================================
  # ê¸°ë³¸ ë¹Œë“œ íƒœìŠ¤í¬
  # ============================================

  build:
    desc: ê¸°ë³¸ ë¹Œë“œ (1:2 ë¹„ìœ¨)
    cmds:
      - python fontforge_script.py
      - echo "âœ… ê¸°ë³¸ ë¹Œë“œ ì™„ë£Œ"

  build:35:
    desc: 3:5 ë¹„ìœ¨ ë¹Œë“œ
    cmds:
      - python fontforge_script.py --35 --do-not-delete-build-dir
      - echo "âœ… 3:5 ë¹„ìœ¨ ë¹Œë“œ ì™„ë£Œ"

  build:console:
    desc: ì½˜ì†” ëª¨ë“œ ë¹Œë“œ (1:2 ë¹„ìœ¨)
    cmds:
      - python fontforge_script.py --console --do-not-delete-build-dir
      - echo "âœ… ì½˜ì†” ëª¨ë“œ ë¹Œë“œ ì™„ë£Œ"

  build:console35:
    desc: ì½˜ì†” ëª¨ë“œ ë¹Œë“œ (3:5 ë¹„ìœ¨)
    cmds:
      - python fontforge_script.py --console --35 --do-not-delete-build-dir
      - echo "âœ… ì½˜ì†” ëª¨ë“œ (3:5) ë¹Œë“œ ì™„ë£Œ"

  build:nf:
    desc: Nerd Fonts í¬í•¨ ë¹Œë“œ (1:2 ë¹„ìœ¨)
    cmds:
      - python fontforge_script.py --nerd-font --do-not-delete-build-dir
      - echo "âœ… Nerd Fonts ë¹Œë“œ ì™„ë£Œ"

  build:nf35:
    desc: Nerd Fonts í¬í•¨ ë¹Œë“œ (3:5 ë¹„ìœ¨)
    cmds:
      - python fontforge_script.py --nerd-font --35 --do-not-delete-build-dir
      - echo "âœ… Nerd Fonts (3:5) ë¹Œë“œ ì™„ë£Œ"

  build:console-nf:
    desc: ì½˜ì†” ëª¨ë“œ + Nerd Fonts (1:2 ë¹„ìœ¨)
    cmds:
      - python fontforge_script.py --console --nerd-font --do-not-delete-build-dir
      - echo "âœ… ì½˜ì†” + Nerd Fonts ë¹Œë“œ ì™„ë£Œ"

  build:console-nf35:
    desc: ì½˜ì†” ëª¨ë“œ + Nerd Fonts (3:5 ë¹„ìœ¨)
    cmds:
      - python fontforge_script.py --console --nerd-font --35 --do-not-delete-build-dir
      - echo "âœ… ì½˜ì†” + Nerd Fonts (3:5) ë¹Œë“œ ì™„ë£Œ"

  build:hs:
    desc: ì „ê° ìŠ¤í˜ì´ìŠ¤ ìˆ¨ê¹€ ë¹Œë“œ (1:2 ë¹„ìœ¨)
    cmds:
      - python fontforge_script.py --hidden-zenkaku-space --do-not-delete-build-dir
      - echo "âœ… ì „ê° ìŠ¤í˜ì´ìŠ¤ ìˆ¨ê¹€ ë¹Œë“œ ì™„ë£Œ"

  build:hs35:
    desc: ì „ê° ìŠ¤í˜ì´ìŠ¤ ìˆ¨ê¹€ ë¹Œë“œ (3:5 ë¹„ìœ¨)
    cmds:
      - python fontforge_script.py --hidden-zenkaku-space --35 --do-not-delete-build-dir
      - echo "âœ… ì „ê° ìŠ¤í˜ì´ìŠ¤ ìˆ¨ê¹€ (3:5) ë¹Œë“œ ì™„ë£Œ"

  # ============================================
  # í°íŠ¸ ìµœì¢… ì²˜ë¦¬ íƒœìŠ¤í¬
  # ============================================

  polish:
    desc: ë¹Œë“œëœ í°íŠ¸ ìµœì¢… ì²˜ë¦¬ (íŒíŒ… ë° ë³‘í•©)
    cmds:
      - python fonttools_script.py
      - echo "âœ… í°íŠ¸ ìµœì¢… ì²˜ë¦¬ ì™„ë£Œ"

  polish:variant:
    desc: íŠ¹ì • ë³€í˜• í°íŠ¸ë§Œ ì²˜ë¦¬
    cmds:
      - python fonttools_script.py {{.VARIANT}}
      - echo "âœ… {{.VARIANT}} ë³€í˜• ì²˜ë¦¬ ì™„ë£Œ"

  # ============================================
  # Nerd Fonts íŒ¨ì¹˜
  # ============================================

  patch:nerd:
    desc: GLG-Mono í°íŠ¸ì— Nerd Fonts íŒ¨ì¹˜ â†’ GLG-MonoNF
    silent: true
    cmds:
      - mkdir -p build/nerd
      - |
        for font in build/GLG-Mono-*.ttf; do
          if [ ! -f "$font" ]; then
            echo "âŒ GLG-Mono í°íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë¹Œë“œë¥¼ ì‹¤í–‰í•˜ì„¸ìš”."
            exit 1
          fi
          variation=$(basename "$font" .ttf | sed 's/GLG-Mono-//')
          echo "ğŸ”§ íŒ¨ì¹˜ ì¤‘: $font â†’ GLG-MonoNF-$variation.ttf"
          mkdir -p build/nerd/tmp
          fontforge --script FontPatcher/font-patcher \
            --complete --careful --mono \
            --no-progressbars \
            --quiet \
            --makegroups 0 \
            --outputdir build/nerd/tmp \
            "$font"
          # ìƒì„±ëœ íŒŒì¼ì„ ì›í•˜ëŠ” ì´ë¦„ìœ¼ë¡œ ë³€ê²½ (NF ì ‘ë¯¸ì‚¬ ì¶”ê°€)
          mv build/nerd/tmp/*.ttf "build/nerd/GLG-MonoNF-$variation.ttf" 2>/dev/null || \
            echo "âš ï¸  $variation ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ"
          rm -rf build/nerd/tmp
        done
        echo ""
        echo "âœ… Nerd Fonts íŒ¨ì¹˜ ì™„ë£Œ (GLG-MonoNF)"
      - echo ""
      - echo "ğŸ”§ í›„ì²˜ë¦¬ í•œê¸€ bearing ì¬ì¡°ì • ì¤‘..."
      - python fix_nf_korean_bearing.py --dir build/nerd
      - echo ""
      - ls -lh build/nerd/GLG-MonoNF-*.ttf 2>/dev/null || echo "ìƒì„±ëœ í°íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤"

  patch:nerd:wide:
    desc: GLG-Mono35 í°íŠ¸ì— Nerd Fonts íŒ¨ì¹˜ â†’ GLG-Mono35NF
    silent: true
    cmds:
      - mkdir -p build/nerd
      - |
        for font in build/GLG-Mono35-*.ttf; do
          if [ ! -f "$font" ]; then
            echo "âŒ GLG-Mono35 í°íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë¹Œë“œë¥¼ ì‹¤í–‰í•˜ì„¸ìš”."
            exit 1
          fi
          variation=$(basename "$font" .ttf | sed 's/GLG-Mono35-//')
          echo "ğŸ”§ íŒ¨ì¹˜ ì¤‘: $font â†’ GLG-Mono35NF-$variation.ttf"
          mkdir -p build/nerd/tmp
          fontforge --script FontPatcher/font-patcher \
            --complete --careful --mono \
            --no-progressbars \
            --quiet \
            --makegroups 0 \
            --outputdir build/nerd/tmp \
            "$font"
          # ìƒì„±ëœ íŒŒì¼ì„ ì›í•˜ëŠ” ì´ë¦„ìœ¼ë¡œ ë³€ê²½ (NF ì ‘ë¯¸ì‚¬ ì¶”ê°€)
          mv build/nerd/tmp/*.ttf "build/nerd/GLG-Mono35NF-$variation.ttf" 2>/dev/null || \
            echo "âš ï¸  $variation ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ"
          rm -rf build/nerd/tmp
        done
        echo ""
        echo "âœ… Nerd Fonts íŒ¨ì¹˜ ì™„ë£Œ (GLG-Mono35NF)"
      - echo ""
      - echo "í›„ì²˜ë¦¬ í•œê¸€ bearing ì¬ì¡°ì • ì¤‘..."
      - python fix_nf_korean_bearing.py --dir build/nerd
      - echo ""
      - ls -lh build/nerd/GLG-Mono35NF-*.ttf 2>/dev/null || echo "ìƒì„±ëœ í°íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤"

  patch:nerd:all:
    desc: ëª¨ë“  Console í°íŠ¸ì— Nerd Fonts íŒ¨ì¹˜ (GLG-Mono + GLG-Mono35Console)
    cmds:
      - echo "ğŸš€ ì „ì²´ Nerd Fonts íŒ¨ì¹˜ ì‹œì‘..."
      - task patch:nerd
      - task patch:nerd:wide
      - echo ""
      - echo "âœ… ì „ì²´ Nerd Fonts íŒ¨ì¹˜ ì™„ë£Œ!"
      - echo ""
      - echo "ğŸ“Š ìƒì„±ëœ í°íŠ¸ ëª©ë¡:"
      - ls -lh build/nerd/*.ttf 2>/dev/null || echo "ìƒì„±ëœ í°íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤"

  clean:nerd:
    desc: íŒ¨ì¹˜ëœ Nerd Fonts í°íŠ¸ ì •ë¦¬
    cmds:
      - rm -rf build/nerd
      - echo "âœ… Nerd Fonts í°íŠ¸ ì •ë¦¬ ì™„ë£Œ"

  # ============================================
  # ì „ì²´ ë¹Œë“œ ì›Œí¬í”Œë¡œìš°
  # ============================================

  full:
    desc: ì „ì²´ ë¹Œë“œ (1:2 + 3:5 ë¹„ìœ¨)
    cmds:
      - echo "ğŸš€ ì „ì²´ ë¹Œë“œ ì‹œì‘..."
      - task clean
      - task build
      - task build:35
      - task polish
      - echo "âœ… ì „ì²´ ë¹Œë“œ ì™„ë£Œ!"
      - ls -lh build/GLG-Mono*.ttf | grep -v fontforge | grep -v fonttools

  full:all:
    desc: ëª¨ë“  ë³€í˜• ë¹Œë“œ (ê¸°ë³¸ + 3:5 + ì½˜ì†”)
    cmds:
      - echo "ğŸš€ ëª¨ë“  ë³€í˜• ë¹Œë“œ ì‹œì‘..."
      - task clean
      - task build
      - task build:35
      - task build:console
      - task build:console35
      - task polish
      - echo "âœ… ëª¨ë“  ë³€í˜• ë¹Œë“œ ì™„ë£Œ!"
      - ls -lh build/GLG-Mono*.ttf | grep -v fontforge | grep -v fonttools

  full:nerd:
    desc: Nerd Fonts í¬í•¨ ì „ì²´ ë¹Œë“œ
    cmds:
      - echo "ğŸš€ Nerd Fonts ì „ì²´ ë¹Œë“œ ì‹œì‘..."
      - task clean
      - task build:console-nf
      - task build:console-nf35
      - task polish
      - echo "âœ… Nerd Fonts ì „ì²´ ë¹Œë“œ ì™„ë£Œ!"
      - ls -lh build/GLG-Mono*.ttf | grep -v fontforge | grep -v fonttools

  # ============================================
  # ë¹ ë¥¸ ë¹Œë“œ (ë””ë²„ê·¸)
  # ============================================

  quick:
    desc: ë¹ ë¥¸ ë¹Œë“œ (Regular ì›¨ì´íŠ¸ë§Œ)
    cmds:
      - python fontforge_script.py --debug
      - python fonttools_script.py
      - ls -lh build/GLG-Mono-Regular.ttf
      - echo "âœ… ë¹ ë¥¸ ë¹Œë“œ ì™„ë£Œ (Regularë§Œ)"

  quick:35:
    desc: ë¹ ë¥¸ ë¹Œë“œ (3:5 ë¹„ìœ¨, Regularë§Œ)
    cmds:
      - python fontforge_script.py --debug --35
      - python fonttools_script.py 35
      - ls -lh build/GLG-Mono35-Regular.ttf
      - echo "âœ… ë¹ ë¥¸ ë¹Œë“œ ì™„ë£Œ (3:5, Regularë§Œ)"

  quick:nerd:
    desc: ë¹ ë¥¸ Nerd Fonts ë¹Œë“œ (Console 1:2 + 3:5, Regular/Boldë§Œ)
    cmds:
      - echo "ğŸš€ ë¹ ë¥¸ Nerd Fonts ë¹Œë“œ ì‹œì‘..."
      - python fontforge_script.py --console --nerd-font --minimal
      - python fontforge_script.py --console --nerd-font --35 --minimal --do-not-delete-build-dir
      - python fonttools_script.py
      - echo ""
      - echo "âœ… ë¹ ë¥¸ Nerd Fonts ë¹Œë“œ ì™„ë£Œ!"
      - echo ""
      - echo "ğŸ“Š ìƒì„±ëœ í°íŠ¸ ëª©ë¡:"
      - ls -lh build/GLG-MonoNF-*.ttf build/GLG-MonoNF35-*.ttf 2>/dev/null || echo "í°íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"

  # ============================================
  # ìœ í‹¸ë¦¬í‹° íƒœìŠ¤í¬
  # ============================================

  clean:
    desc: ë¹Œë“œ ë””ë ‰í† ë¦¬ ì •ë¦¬
    cmds:
      - rm -rf build
      - mkdir -p build
      - echo "âœ… ë¹Œë“œ ë””ë ‰í† ë¦¬ ì •ë¦¬ ì™„ë£Œ"

  check:
    desc: ìƒì„±ëœ í°íŠ¸ íŒŒì¼ í™•ì¸
    cmds:
      - echo "ğŸ“Š ìƒì„±ëœ í°íŠ¸ íŒŒì¼ ëª©ë¡:"
      - ls -lh build/GLG-Mono*.ttf | grep -v fontforge | grep -v fonttools || echo "í°íŠ¸ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
      - echo ""
      - echo "ğŸ“ˆ ê¸€ë¦¬í”„ ìˆ˜ í™•ì¸:"
      - python work_scripts/check_glyph_number.py build/GLG-Mono-Regular.ttf 2>/dev/null || echo "Regular í°íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."

  verify:
    desc: í•œê¸€/ì¼ë³¸ì–´/ì´ëª¨ì§€ ë¬¸ì í™•ì¸
    cmds:
      - |
        python3 -c "
        import fontforge
        font = fontforge.open('build/GLG-Mono-Regular.ttf')
        korean = [(0xAC00, 'ê°€'), (0xD7A3, 'í£')]
        japanese = [(0x3042, 'ã‚'), (0x30A2, 'ã‚¢')]
        emoji = [
            (0x2713, 'âœ“', 'Check mark'),
            (0x2714, 'âœ”', 'Heavy check mark'),
            (0x2717, 'âœ—', 'Ballot X'),
            (0x2718, 'âœ˜', 'Heavy ballot X'),
            (0x274C, 'âŒ', 'Cross mark')
        ]
        print('í•œê¸€:', all(c in font for c, _ in korean))
        print('ì¼ë³¸ì–´:', all(c in font for c, _ in japanese))
        print('ì´ëª¨ì§€:')
        for code, char, name in emoji:
            present = code in font
            status = 'âœ“' if present else 'âœ—'
            print(f'  {status} U+{code:04X} {char} ({name})')
        font.close()
        "

  verify:nerd:
    desc: Nerd Fonts ì•„ì´ì½˜ í™•ì¸
    cmds:
      - |
        python3 -c "
        import fontforge
        import sys
        import os

        # Nerd Fonts íŒŒì¼ ì°¾ê¸° (ë‘ ê°€ì§€ ê²½ë¡œ í™•ì¸)
        nf_fonts = []

        # 1. build ë””ë ‰í† ë¦¬ - fontforge_script.py --nerd-fontë¡œ ë¹Œë“œëœ íŒŒì¼
        if os.path.exists('build'):
            for f in os.listdir('build'):
                if 'NF' in f and f.endswith('.ttf') and not f.startswith('fontforge') and not f.startswith('fonttools'):
                    nf_fonts.append(os.path.join('build', f))

        # 2. build/nerd ë””ë ‰í† ë¦¬ - FontPatcherë¡œ íŒ¨ì¹˜ëœ íŒŒì¼
        if os.path.exists('build/nerd'):
            for f in os.listdir('build/nerd'):
                if f.endswith('.ttf'):
                    nf_fonts.append(os.path.join('build/nerd', f))

        if not nf_fonts:
            print('âŒ Nerd Fonts í°íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')
            print('   ë¨¼ì € ë¹Œë“œë¥¼ ì‹¤í–‰í•˜ì„¸ìš”:')
            print('   - task build:nf ë˜ëŠ” task quick:nerd (ë‚´ì¥ ë¹Œë“œ)')
            print('   - task patch:nerd:all (FontPatcher íŒ¨ì¹˜)')
            sys.exit(0)

        # ì²« ë²ˆì§¸ Nerd Fonts íŒŒì¼ í™•ì¸
        font_path = sorted(nf_fonts)[0]
        print(f'í™•ì¸ ì¤‘: {os.path.basename(font_path)}')
        print()

        font = fontforge.open(font_path)

        # Nerd Fonts ì£¼ìš” ë²”ìœ„ í™•ì¸
        nerd_ranges = [
            ('Powerline', [
                (0xE0A0, 'Branch'),
                (0xE0A1, 'Line number'),
                (0xE0A2, 'Readonly'),
                (0xE0B0, 'Left hard divider'),
                (0xE0B2, 'Right hard divider'),
            ]),
            ('Devicons', [
                (0xE700, 'Aarch64'),
                (0xE779, 'GNU'),
                (0xE7A2, 'CouchDB'),
            ]),
            ('Font Awesome', [
                (0xF015, 'House'),
                (0xF07B, 'Folder'),
                (0xF09B, 'GitHub'),
                (0xF113, 'GitHub Alt'),
                (0xF121, 'Code'),
            ]),
            ('Octicons', [
                (0xF400, 'Light bulb'),
                (0xF417, 'Git commit'),
            ]),
            ('Pomicons', [
                (0xE000, 'Clean code'),
            ]),
        ]

        for category, icons in nerd_ranges:
            print(f'{category}:')
            for code, name in icons:
                present = code in font
                status = 'âœ“' if present else 'âœ—'
                char = chr(code)
                print(f'  {status} U+{code:04X} {char} ({name})')
            print()

        # ì „ì²´ í†µê³„
        powerline_range = sum(1 for i in range(0xE0A0, 0xE0D8) if i in font)
        devicons_range = sum(1 for i in range(0xE700, 0xE7C6) if i in font)
        fontawesome_range = sum(1 for i in range(0xF000, 0xF2E1) if i in font)

        print('ë²”ìœ„ë³„ í†µê³„:')
        print(f'  Powerline (E0A0-E0D7): {powerline_range}/56 ê¸€ë¦¬í”„')
        print(f'  Devicons (E700-E7C5): {devicons_range}/198 ê¸€ë¦¬í”„')
        print(f'  Font Awesome (F000-F2E0): {fontawesome_range}/737 ê¸€ë¦¬í”„')

        font.close()
        "

  verify:bearing:
    desc: í•œê¸€ bearing ê²€ì¦ (NF vs non-NF ë¹„êµ)
    cmds:
      - |
        if [ ! -f "build/GLG-Mono-Regular.ttf" ]; then
          echo "âŒ ê¸°ë³¸ í°íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë¹Œë“œë¥¼ ì‹¤í–‰í•˜ì„¸ìš”: task build:console"
          exit 1
        fi
        if [ ! -f "build/nerd/GLG-MonoNF-Regular.ttf" ]; then
          echo "âŒ Nerd Fonts í°íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € íŒ¨ì¹˜ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”: task patch:nerd"
          exit 1
        fi
        echo "ğŸ” í•œê¸€ bearing ê²€ì¦ (NF vs non-NF)"
        echo ""
        python test_korean_bearing_nf.py build/GLG-Mono-Regular.ttf build/nerd/GLG-MonoNF-Regular.ttf

  install:
    desc: í°íŠ¸ë¥¼ ì‹œìŠ¤í…œì— ì„¤ì¹˜ (macOS)
    cmds:
      - cp build/GLG-Mono-*.ttf ~/Library/Fonts/
      - echo "âœ… í°íŠ¸ ì„¤ì¹˜ ì™„ë£Œ (~/Library/Fonts/)"

  # ============================================
  # ë¦´ë¦¬ìŠ¤ ì¤€ë¹„
  # ============================================

  release:
    desc: ë¦´ë¦¬ìŠ¤ íŒŒì¼ ì¤€ë¹„
    vars:
      TIMESTAMP:
        sh: date +%Y%m%d%H%M%S
    cmds:
      - mkdir -p release_files/build_{{.TIMESTAMP}}
      - cp build/GLG-Mono*.ttf release_files/build_{{.TIMESTAMP}}/ 2>/dev/null || true
      - echo "âœ… ë¦´ë¦¬ìŠ¤ íŒŒì¼ ì¤€ë¹„ ì™„ë£Œ release_files/build_{{.TIMESTAMP}}/"
      - ls -lh release_files/build_{{.TIMESTAMP}}/

  # ============================================
  # ì •ë³´ í‘œì‹œ
  # ============================================

  info:
    desc: ë¹Œë“œ í™˜ê²½ ì •ë³´ í‘œì‹œ
    cmds:
      - echo "ğŸ“¦ GLG-Mono ë¹Œë“œ ì‹œìŠ¤í…œ"
      - echo "ë²„ì „{{"{{"}} .VERSION {{"}}"}}"
      - echo ""
      - echo "ğŸ Python ë²„ì „:"
      - python --version
      - echo ""
      - echo "ğŸ”§ FontForge ë²„ì „:"
      - fontforge --version 2>&1 | head -1 || echo "FontForgeë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
      - echo ""
      - echo "ğŸ“š ì„¤ì¹˜ëœ íŒ¨í‚¤ì§€:"
      - pip3 list | grep -E "fonttools|ttfautohint" || echo "í•„ìš”í•œ íŒ¨í‚¤ì§€ë¥¼ ì„¤ì¹˜í•˜ì„¸ìš”"
